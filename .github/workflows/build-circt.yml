name: Build CIRCT Libraries

on:
  push:
    tags:
      - "circt-v*"
  workflow_dispatch:
    inputs:
      circt_version:
        description: "CIRCT firtool release tag (e.g., 1.140.0)"
        required: true
        type: string

permissions:
  contents: write

env:
  CIRCT_VERSION: ${{ inputs.circt_version || github.ref_name }}

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            archive_ext: tar.gz
            cmake_generator: Ninja
            shell: bash
            parallel_jobs: 4
          - os: macos-latest
            platform: macos-arm64
            archive_ext: tar.gz
            cmake_generator: Ninja
            shell: bash
            # macOS M1 runner has only 7 GB RAM; limit parallelism to avoid OOM
            parallel_jobs: 2
          # Windows: LLVM_BUILD_LLVM_DYLIB is not supported with the MSVC ABI.
          # This entry produces a static CIRCT build (tools + static libs + headers).
          - os: windows-latest
            platform: windows-x64
            archive_ext: zip
            cmake_generator: Ninja
            shell: cmd
            parallel_jobs: 4

    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: ${{ matrix.shell }}

    timeout-minutes: 360

    steps:
      - name: Derive CIRCT version from tag
        id: version
        shell: bash
        run: |
          RAW="${{ env.CIRCT_VERSION }}"
          VERSION=$(echo "$RAW" | sed -E 's/^[a-zA-Z]+-v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Failed to extract valid version from '$RAW'. Expected format: circt-vX.Y.Z or X.Y.Z"
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=firtool-${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Building CIRCT version: ${VERSION}"

      - name: Install build tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build ccache

      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install ninja ccache

      - name: Set up MSVC environment (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install build tools (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install ninja ccache llvm -y

      - name: Set up ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: circt-${{ matrix.platform }}-${{ steps.version.outputs.version }}
          max-size: 5G

      - name: Free disk space (Linux)
        if: runner.os == 'Linux'
        uses: jlumbroso/free-disk-space@v1
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Free disk space (macOS)
        if: runner.os == 'macOS'
        run: |
          sudo xcrun simctl delete all || true
          sudo rm -rf /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform || true
          sudo rm -rf /Applications/Xcode.app/Contents/Developer/Platforms/AppleTVOS.platform || true
          sudo rm -rf /Applications/Xcode.app/Contents/Developer/Platforms/WatchOS.platform || true
          brew cleanup --prune=all || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf /usr/local/lib/android || true
          df -h

      - name: Clone CIRCT source
        run: |
          git clone --recursive --depth 1 --shallow-submodules --branch ${{ steps.version.outputs.tag }} https://github.com/llvm/circt.git

      - name: Configure CIRCT (Unix)
        if: runner.os != 'Windows'
        run: |
          cmake -G Ninja -S circt/llvm/llvm -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DLLVM_ENABLE_PROJECTS="mlir" \
            -DLLVM_EXTERNAL_PROJECTS=circt \
            -DLLVM_EXTERNAL_CIRCT_SOURCE_DIR=${{ github.workspace }}/circt \
            -DLLVM_BUILD_LLVM_DYLIB=ON \
            -DLLVM_LINK_LLVM_DYLIB=ON \
            -DLLVM_TARGETS_TO_BUILD="host" \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_INCLUDE_DOCS=OFF \
            -DLLVM_ENABLE_ASSERTIONS=OFF \
            -DLLVM_ENABLE_ZLIB=OFF \
            -DLLVM_ENABLE_ZSTD=OFF

      # Windows: LLVM_BUILD_LLVM_DYLIB is not supported with the MSVC ABI.
      # This produces static CIRCT/LLVM/MLIR libraries plus CIRCT tools.
      - name: Configure CIRCT (Windows)
        if: runner.os == 'Windows'
        run: |
          cmake -G Ninja -S circt/llvm/llvm -B build ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install ^
            -DCMAKE_C_COMPILER=clang-cl ^
            -DCMAKE_CXX_COMPILER=clang-cl ^
            -DLLVM_USE_LINKER=lld ^
            -DCMAKE_C_COMPILER_LAUNCHER=ccache ^
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache ^
            -DLLVM_ENABLE_PROJECTS="mlir" ^
            -DLLVM_EXTERNAL_PROJECTS=circt ^
            -DLLVM_EXTERNAL_CIRCT_SOURCE_DIR=${{ github.workspace }}/circt ^
            -DLLVM_TARGETS_TO_BUILD="host" ^
            -DLLVM_INCLUDE_TESTS=OFF ^
            -DLLVM_INCLUDE_EXAMPLES=OFF ^
            -DLLVM_INCLUDE_BENCHMARKS=OFF ^
            -DLLVM_INCLUDE_DOCS=OFF ^
            -DLLVM_ENABLE_ASSERTIONS=OFF ^
            -DLLVM_ENABLE_ZLIB=OFF ^
            -DLLVM_ENABLE_ZSTD=OFF

      - name: Build CIRCT
        run: cmake --build build --config Release --parallel ${{ matrix.parallel_jobs }}

      - name: Install CIRCT
        run: cmake --install build --config Release

      - name: Package archive (Unix tar.gz)
        if: runner.os != 'Windows'
        working-directory: ${{ github.workspace }}
        run: |
          tar -czf circt-${{ steps.version.outputs.version }}-${{ matrix.platform }}.tar.gz -C install .

      - name: Package archive (Windows zip)
        if: runner.os == 'Windows'
        shell: powershell
        working-directory: ${{ github.workspace }}
        run: |
          Compress-Archive -Path install\* -DestinationPath circt-${{ steps.version.outputs.version }}-${{ matrix.platform }}.zip

      - name: Generate checksum
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          ARCHIVE="circt-${{ steps.version.outputs.version }}-${{ matrix.platform }}.${{ matrix.archive_ext }}"
          if command -v sha256sum &>/dev/null; then
            sha256sum "$ARCHIVE" > "$ARCHIVE.sha256"
          else
            shasum -a 256 "$ARCHIVE" > "$ARCHIVE.sha256"
          fi

      - name: Upload release assets
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            circt-${{ steps.version.outputs.version }}-${{ matrix.platform }}.${{ matrix.archive_ext }}
            circt-${{ steps.version.outputs.version }}-${{ matrix.platform }}.${{ matrix.archive_ext }}.sha256
          tag_name: ${{ github.ref_name }}
          name: "CIRCT ${{ steps.version.outputs.version }}"
          draft: false
          prerelease: false

      - name: Upload artifact (manual dispatch)
        if: github.ref_type != 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: circt-${{ steps.version.outputs.version }}-${{ matrix.platform }}
          path: circt-${{ steps.version.outputs.version }}-${{ matrix.platform }}.${{ matrix.archive_ext }}
          retention-days: 7
